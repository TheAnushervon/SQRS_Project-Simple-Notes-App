name: CI

on:
  push:
    branches: ["dev1", "dev/iliyasone", "dev2"]
  pull_request:
    branches: ["main", "development"]

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: simple_notes_app
    env:
      X_RAPID_API_KEY: ${{ secrets.X_RAPID_API_KEY }}
      X_RAPID_API_HOST: deep-translate1.p.rapidapi.com
      DATABASE_URL: sqlite:////app/app/db/notes.db
      JWT_SECRET_KEY: ci-test-secret-dummy-12345
    steps:
      - uses: actions/checkout@v4
      - name: Set Up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install Poetry
        run: pip install poetry
      - name: Install dependencies
        run: poetry install
      - name: verify of compilance with PEP8 standard
        run: poetry run flake8 .
      - name: Run unit tests
        run: poetry run pytest --cov=app --cov-fail-under=90 -s
      - name: Run mutation tests
        run: poetry run mutmut run
      - name: Check for security via bandit
        run: poetry run bandit -r .
      - name: Check maintainability index
        run: poetry run radon mi app/ -n B
      - name: Check documentation coverage
        run: poetry run interrogate app/ --fail-under=90 -q

